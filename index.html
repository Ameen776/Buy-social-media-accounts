<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIAL ACCOUNTS MARKET - سوق الحسابات</title>
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: #0a0a1a;
            color: #fff;
            overflow-x: hidden;
        }

        /* شاشة الدخول ثلاثية الأبعاد */
        .login-container {
            position: fixed;
            width: 100%;
            height: 100vh;
            top: 0;
            left: 0;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 100%);
        }

        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .login-box {
            position: relative;
            z-index: 2;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 75px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-15px) rotate(0.5deg); }
            75% { transform: translateY(-10px) rotate(-0.5deg); }
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 36px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-weight: 900;
        }

        .logo p {
            color: #94a3b8;
            font-size: 16px;
        }

        .social-cube {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            position: relative;
            transform-style: preserve-3d;
            animation: rotateCube 15s infinite linear;
        }

        @keyframes rotateCube {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            25% { transform: rotateX(90deg) rotateY(90deg); }
            50% { transform: rotateX(180deg) rotateY(180deg); }
            75% { transform: rotateX(270deg) rotateY(270deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }

        .cube-face {
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #3b82f6;
        }

        .front { transform: translateZ(75px); }
        .back { transform: rotateY(180deg) translateZ(75px); }
        .right { transform: rotateY(90deg) translateZ(75px); }
        .left { transform: rotateY(-90deg) translateZ(75px); }
        .top { transform: rotateX(90deg) translateZ(75px); }
        .bottom { transform: rotateX(-90deg) translateZ(75px); }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            color: #f1f5f9;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
        }

        .loading-spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-check {
            display: none;
            width: 80px;
            height: 80px;
            margin: 20px auto;
            color: #10b981;
            font-size: 80px;
            animation: checkmark 0.5s ease-in-out;
        }

        @keyframes checkmark {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .hidden {
            display: none !important;
        }

        /* التطبيق الرئيسي */
        #app {
            opacity: 0;
            transition: opacity 0.5s;
        }

        #app.loaded {
            opacity: 1;
        }

        /* شريط التنقل */
        .navbar {
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-brand i {
            font-size: 32px;
            color: #3b82f6;
        }

        .nav-brand h2 {
            font-size: 28px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 12px 25px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid rgba(239, 68, 68, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* المحتوى الرئيسي */
        .container {
            padding: 30px 5%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 36px;
            margin-bottom: 30px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        /* بطاقات الحسابات */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .account-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s;
            position: relative;
        }

        .account-card:hover {
            transform: translateY(-10px);
            border-color: #3b82f6;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .account-header {
            padding: 25px;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .platform-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
        }

        .instagram { background: linear-gradient(45deg, #833AB4, #E1306C, #FCAF45); }
        .facebook { background: #1877F2; }
        .tiktok { background: #000; }
        .twitter { background: #1DA1F2; }
        .youtube { background: #FF0000; }
        .snapchat { background: #FFFC00; color: #000 !important; }

        .account-title h3 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .account-title p {
            color: #94a3b8;
            font-size: 16px;
        }

        .account-details {
            padding: 25px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }

        .detail-label {
            color: #94a3b8;
        }

        .detail-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        .price-tag {
            text-align: center;
            font-size: 36px;
            font-weight: 800;
            color: #10b981;
            padding: 25px;
            background: rgba(16, 185, 129, 0.1);
            border-top: 1px solid rgba(59, 130, 246, 0.2);
        }

        .account-actions {
            padding: 0 25px 25px;
            display: flex;
            gap: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-btn.contact {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            color: white;
        }

        .action-btn.chat {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-3px);
        }

        .seller-info {
            padding: 20px;
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .seller-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        /* نافذة الإضافة */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 25px 75px rgba(0, 0, 0, 0.8);
            animation: modalSlide 0.4s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-100px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 28px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-modal {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 30px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .image-upload-area {
            border: 3px dashed rgba(59, 130, 246, 0.5);
            border-radius: 20px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .image-upload-area:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .image-upload-area i {
            font-size: 60px;
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .image-preview-item {
            position: relative;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* نافذة الدردشة */
        .chat-modal {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 400px;
            height: 600px;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            z-index: 1000;
            flex-direction: column;
            box-shadow: 0 25px 75px rgba(0, 0, 0, 0.8);
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 18px;
            position: relative;
        }

        .message.sent {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: rgba(30, 41, 59, 0.8);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            gap: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 16px;
        }

        .send-btn {
            width: 60px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-size: 20px;
        }

        /* صفحة المستخدمين */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .user-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s;
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
        }

        .user-card-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: 700;
        }

        .user-card-info h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .user-card-info p {
            color: #94a3b8;
            font-size: 14px;
        }

        /* التنبيهات */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 25px;
            border-radius: 12px;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert.success {
            border-color: #10b981;
            color: #10b981;
        }

        .alert.error {
            border-color: #ef4444;
            color: #ef4444;
        }

        .alert.info {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* التجاوب مع الأجهزة */
        @media (max-width: 1200px) {
            .accounts-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
            }
            
            .nav-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .accounts-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .chat-modal {
                width: 100%;
                height: 80vh;
                bottom: 0;
                left: 0;
                border-radius: 20px 20px 0 0;
            }
            
            .users-grid {
                grid-template-columns: 1fr;
            }
            
            .login-box {
                padding: 30px 20px;
            }
            
            .social-cube {
                width: 120px;
                height: 120px;
            }
            
            .cube-face {
                width: 120px;
                height: 120px;
            }
            
            .front { transform: translateZ(60px); }
            .back { transform: rotateY(180deg) translateZ(60px); }
            .right { transform: rotateY(90deg) translateZ(60px); }
            .left { transform: rotateY(-90deg) translateZ(60px); }
            .top { transform: rotateX(90deg) translateZ(60px); }
            .bottom { transform: rotateX(-90deg) translateZ(60px); }
        }
    </style>
</head>
<body>
    <!-- شاشة الدخول ثلاثية الأبعاد -->
    <div class="login-container" id="loginContainer">
        <canvas id="three-canvas"></canvas>
        <div class="login-box">
            <div class="logo">
                <div class="social-cube">
                    <div class="cube-face front"><i class="fab fa-instagram"></i></div>
                    <div class="cube-face back"><i class="fab fa-facebook"></i></div>
                    <div class="cube-face right"><i class="fab fa-tiktok"></i></div>
                    <div class="cube-face left"><i class="fab fa-twitter"></i></div>
                    <div class="cube-face top"><i class="fab fa-youtube"></i></div>
                    <div class="cube-face bottom"><i class="fas fa-shopping-cart"></i></div>
                </div>
                <h1>سوق الحسابات</h1>
                <p>منصة بيع وشراء حسابات التواصل الاجتماعي</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                    <input type="email" id="loginEmail" required placeholder="example@email.com">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> كلمة المرور</label>
                    <input type="password" id="loginPassword" required minlength="6">
                </div>
                
                <button type="submit" class="btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                </button>
                
                <p style="text-align: center; margin-top: 20px; color: #94a3b8;">
                    ليس لديك حساب؟ <a href="#" id="showRegister" style="color: #3b82f6; text-decoration: none; font-weight: 600;">سجل الآن</a>
                </p>
            </form>
            
            <form id="registerForm" class="hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> الاسم الكامل</label>
                        <input type="text" id="registerName" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> رقم الهاتف</label>
                        <input type="tel" id="registerPhone" required placeholder="05XXXXXXXX">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> الدولة</label>
                        <select id="registerCountry" required>
                            <option value="">اختر الدولة</option>
                            <option value="السعودية">السعودية</option>
                            <option value="الإمارات">الإمارات</option>
                            <option value="الكويت">الكويت</option>
                            <option value="قطر">قطر</option>
                            <option value="عُمان">عُمان</option>
                            <option value="البحرين">البحرين</option>
                            <option value="مصر">مصر</option>
                            <option value="الأردن">الأردن</option>
                            <option value="لبنان">لبنان</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-home"></i> المدينة</label>
                        <input type="text" id="registerCity" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-map"></i> العنوان</label>
                    <textarea id="registerAddress" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                    <input type="email" id="registerEmail" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> كلمة المرور</label>
                        <input type="password" id="registerPassword" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> تأكيد كلمة المرور</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="registerBtn">
                    <i class="fas fa-user-plus"></i> إنشاء حساب جديد
                </button>
                
                <div class="loading-spinner" id="registerSpinner"></div>
                <div class="success-check" id="registerSuccess"><i class="fas fa-check-circle"></i></div>
                
                <p style="text-align: center; margin-top: 20px; color: #94a3b8;">
                    لديك حساب بالفعل؟ <a href="#" id="showLogin" style="color: #3b82f6; text-decoration: none; font-weight: 600;">سجل الدخول</a>
                </p>
            </form>
            
            <div id="authMessage" class="hidden"></div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="app" class="hidden">
        <!-- شريط التنقل -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-store"></i>
                <h2>سوق الحسابات</h2>
            </div>
            
            <div class="nav-actions">
                <a href="#" class="nav-btn" id="openAddModal">
                    <i class="fas fa-plus-circle"></i>
                    إضافة حساب للبيع
                </a>
                
                <a href="#" class="nav-btn" id="viewUsersBtn" style="background: linear-gradient(90deg, #8b5cf6, #ec4899);">
                    <i class="fas fa-users"></i>
                    المستخدمين
                </a>
                
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">أ</div>
                    <div>
                        <div id="userName">أحمد محمد</div>
                        <div style="font-size: 12px; color: #94a3b8;" id="userPhone">05XXXXXXXX</div>
                    </div>
                </div>
                
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </nav>

        <!-- المحتوى الرئيسي -->
        <div class="container">
            <h1 class="page-title">الحسابات المتاحة للشراء</h1>
            
            <div id="accountsContainer" class="accounts-grid">
                <!-- الحسابات تظهر هنا من Firebase -->
            </div>
            
            <div id="usersContainer" class="users-grid hidden">
                <!-- المستخدمين يظهرون هنا -->
            </div>
        </div>

        <!-- نافذة إضافة حساب -->
        <div class="modal-overlay" id="addModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-plus-circle"></i> إضافة حساب جديد للبيع</h2>
                    <button class="close-modal" id="closeAddModal">&times;</button>
                </div>
                
                <form id="addAccountForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-globe"></i> منصة التواصل</label>
                            <select id="accountPlatform" required>
                                <option value="">اختر المنصة</option>
                                <option value="instagram">إنستغرام</option>
                                <option value="facebook">فيسبوك</option>
                                <option value="tiktok">تيك توك</option>
                                <option value="twitter">تويتر</option>
                                <option value="youtube">يوتيوب</option>
                                <option value="snapchat">سناب شات</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-at"></i> اسم المستخدم</label>
                            <input type="text" id="accountUsername" placeholder="@username" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-users"></i> عدد المتابعين</label>
                            <input type="number" id="accountFollowers" required>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> السعر (ريال سعودي)</label>
                            <input type="number" id="accountPrice" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-file-alt"></i> وصف الحساب</label>
                        <textarea id="accountDescription" rows="3" placeholder="صف الحساب..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-images"></i> صور إثبات الملكية (2-3 صور)</label>
                        <div class="image-upload-area" id="imageUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p style="font-size: 18px; margin-bottom: 10px;">انقر لرفع صور إثبات ملكية الحساب</p>
                            <p style="color: #94a3b8;">يمكنك رفع حتى 3 صور</p>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                        </div>
                        
                        <div class="images-preview" id="imagesPreview">
                            <!-- معاينة الصور تظهر هنا -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" style="margin-top: 20px;">
                        <i class="fas fa-upload"></i> نشر الحساب للبيع
                    </button>
                </form>
            </div>
        </div>

        <!-- نافذة الدردشة -->
        <div class="chat-modal" id="chatModal">
            <div class="chat-header">
                <div class="chat-user-info">
                    <div class="chat-avatar" id="chatAvatar">س</div>
                    <div>
                        <h4 id="chatUserName">سالم أحمد</h4>
                        <p style="font-size: 12px; color: #94a3b8;" id="chatUserStatus">متصل الآن</p>
                    </div>
                </div>
                <button class="close-modal" id="closeChat">&times;</button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- الرسائل تظهر هنا -->
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="اكتب رسالتك هنا...">
                <button class="send-btn" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- التنبيهات -->
    <div id="alertContainer"></div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB8lL0EtnVYNtUqE7C2gzqiwFHK23TTM7w",
            authDomain: "hakr-1xbet.firebaseapp.com",
            projectId: "hakr-1xbet",
            storageBucket: "hakr-1xbet.firebasestorage.app",
            messagingSenderId: "516332204234",
            appId: "1:516332204234:web:e7a87ff173c5086c184433",
            measurementId: "G-Y8Y9GKS43H"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // حالات التطبيق
        let currentUser = null;
        let currentChatUser = null;
        let chatListener = null;
        let uploadedImages = [];
        let imgbbApiKey = 'fc90a0a005031a9d572ad3476ef545c2';

        // 1. المشهد ثلاثي الأبعاد
        function initThreeJS() {
            const canvas = document.getElementById('three-canvas');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ 
                canvas, 
                alpha: true, 
                antialias: true,
                powerPreference: "high-performance"
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            // إضافة الضوء
            const light = new THREE.DirectionalLight(0x3b82f6, 1);
            light.position.set(5, 5, 5);
            scene.add(light);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            
            // خلفية النجوم
            const starsGeometry = new THREE.BufferGeometry();
            const starsCount = 5000;
            const starsPositions = new Float32Array(starsCount * 3);
            
            for(let i = 0; i < starsCount * 3; i++) {
                starsPositions[i] = (Math.random() - 0.5) * 2000;
            }
            
            starsGeometry.setAttribute('position', new THREE.BufferAttribute(starsPositions, 3));
            
            const starsMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 2,
                sizeAttenuation: true
            });
            
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);
            
            // تحريك الكاميرا
            camera.position.z = 15;
            
            // دوران النجوم
            function animate() {
                requestAnimationFrame(animate);
                
                stars.rotation.x += 0.0005;
                stars.rotation.y += 0.0005;
                
                renderer.render(scene, camera);
            }
            
            animate();
            
            // تكيف مع تغيير حجم النافذة
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // 2. نظام المصادقة
        function initAuth() {
            // تبديل بين نموذج الدخول والتسجيل
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            });
            
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            });
            
            // تسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const loginBtn = document.getElementById('loginBtn');
                const originalText = loginBtn.innerHTML;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الدخول...';
                loginBtn.disabled = true;
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                }
            });
            
            // إنشاء حساب جديد
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value;
                const phone = document.getElementById('registerPhone').value;
                const country = document.getElementById('registerCountry').value;
                const city = document.getElementById('registerCity').value;
                const address = document.getElementById('registerAddress').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (password !== confirmPassword) {
                    showAlert('كلمات المرور غير متطابقة', 'error');
                    return;
                }
                
                // إخفاء النموذج وإظهار التحميل
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('registerSpinner').style.display = 'block';
                
                try {
                    // إنشاء حساب Firebase
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // حفظ بيانات المستخدم الإضافية
                    await db.collection('users').doc(user.uid).set({
                        name,
                        email,
                        phone,
                        country,
                        city,
                        address,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        avatarColor: getRandomColor(),
                        role: 'user'
                    });
                    
                    // محاكاة عملية التسجيل
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // إظعلام النجاح
                    document.getElementById('registerSpinner').style.display = 'none';
                    document.getElementById('registerSuccess').style.display = 'block';
                    
                    // الانتقال للتطبيق بعد 2 ثانية
                    setTimeout(() => {
                        showApp();
                    }, 2000);
                    
                } catch (error) {
                    document.getElementById('registerSpinner').style.display = 'none';
                    document.getElementById('registerForm').classList.remove('hidden');
                    showAlert(error.message, 'error');
                }
            });
            
            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut();
            });
            
            // مراقبة حالة المستخدم
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        updateUserUI(userData);
                        loadAccounts();
                        showApp();
                    } else {
                        // إذا لم يكن للمستخدم بيانات، إنشاءها
                        await db.collection('users').doc(user.uid).set({
                            name: user.email.split('@')[0],
                            email: user.email,
                            phone: '',
                            country: '',
                            city: '',
                            address: '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            avatarColor: getRandomColor(),
                            role: 'user'
                        });
                        
                        const newUserDoc = await db.collection('users').doc(user.uid).get();
                        updateUserUI(newUserDoc.data());
                        loadAccounts();
                        showApp();
                    }
                } else {
                    currentUser = null;
                    document.getElementById('loginContainer').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                }
            });
        }

        // 3. تحديث واجهة المستخدم
        function updateUserUI(userData) {
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userPhone').textContent = userData.phone || 'بدون رقم';
            document.getElementById('userAvatar').textContent = userData.name.charAt(0);
            document.getElementById('userAvatar').style.background = userData.avatarColor;
        }

        // 4. تحميل الحسابات
        async function loadAccounts() {
            const container = document.getElementById('accountsContainer');
            container.innerHTML = '<p style="text-align: center; width: 100%; color: #94a3b8;">جاري تحميل الحسابات...</p>';
            
            try {
                const snapshot = await db.collection('accounts')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; width: 100%; color: #94a3b8; padding: 40px;">لا توجد حسابات للبيع حالياً</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const account = doc.data();
                    const accountId = doc.id;
                    addAccountCard(account, accountId);
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
                container.innerHTML = '<p style="text-align: center; width: 100%; color: #ef4444; padding: 40px;">حدث خطأ في تحميل الحسابات</p>';
            }
        }

        // 5. إضافة بطاقة حساب
        function addAccountCard(account, accountId) {
            const container = document.getElementById('accountsContainer');
            
            const platformIcons = {
                instagram: { icon: 'fab fa-instagram', class: 'instagram', name: 'إنستغرام' },
                facebook: { icon: 'fab fa-facebook', class: 'facebook', name: 'فيسبوك' },
                tiktok: { icon: 'fab fa-tiktok', class: 'tiktok', name: 'تيك توك' },
                twitter: { icon: 'fab fa-twitter', class: 'twitter', name: 'تويتر' },
                youtube: { icon: 'fab fa-youtube', class: 'youtube', name: 'يوتيوب' },
                snapchat: { icon: 'fab fa-snapchat', class: 'snapchat', name: 'سناب شات' }
            };
            
            const platform = platformIcons[account.platform] || platformIcons.instagram;
            
            const accountCard = document.createElement('div');
            accountCard.className = 'account-card';
            accountCard.innerHTML = `
                <div class="account-header">
                    <div class="platform-icon ${platform.class}">
                        <i class="${platform.icon}"></i>
                    </div>
                    <div class="account-title">
                        <h3>${platform.name}</h3>
                        <p>${account.username}</p>
                    </div>
                </div>
                
                <div class="account-details">
                    <div class="detail-row">
                        <span class="detail-label">المتابعون</span>
                        <span class="detail-value">${account.followers.toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">البائع</span>
                        <span class="detail-value">${account.sellerName}</span>
                    </div>
                    ${account.description ? `
                    <div class="detail-row">
                        <span class="detail-label">الوصف</span>
                        <span class="detail-value">${account.description}</span>
                    </div>` : ''}
                </div>
                
                <div class="price-tag">${account.price.toLocaleString()} ر.س</div>
                
                <div class="account-actions">
                    <button class="action-btn contact" onclick="contactSeller('${account.sellerId}')">
                        <i class="fas fa-phone-alt"></i>
                        تواصل مع البائع
                    </button>
                    <button class="action-btn chat" onclick="startChat('${account.sellerId}', '${account.sellerName}')">
                        <i class="fas fa-comment-dots"></i>
                        دردشة مباشرة
                    </button>
                </div>
                
                <div class="seller-info">
                    <div class="seller-avatar" style="background: ${account.sellerAvatarColor || getRandomColor()}">
                        ${account.sellerName.charAt(0)}
                    </div>
                    <div>
                        <h4>${account.sellerName}</h4>
                        <p style="color: #94a3b8; font-size: 14px;">بائع منذ ${new Date(account.createdAt?.toDate()).toLocaleDateString('ar-SA')}</p>
                    </div>
                </div>
            `;
            
            container.appendChild(accountCard);
        }

        // 6. تحميل المستخدمين
        async function loadUsers() {
            const container = document.getElementById('usersContainer');
            container.innerHTML = '<p style="text-align: center; width: 100%; color: #94a3b8;">جاري تحميل المستخدمين...</p>';
            
            try {
                const snapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userId = doc.id;
                    
                    if (userId === currentUser.uid) return; // تخطي المستخدم الحالي
                    
                    addUserCard(user, userId);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<p style="text-align: center; width: 100%; color: #ef4444;">حدث خطأ في تحميل المستخدمين</p>';
            }
        }

        // 7. إضافة بطاقة مستخدم
        function addUserCard(user, userId) {
            const container = document.getElementById('usersContainer');
            
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.innerHTML = `
                <div class="user-card-avatar" style="background: ${user.avatarColor || getRandomColor()}">
                    ${user.name.charAt(0)}
                </div>
                <div class="user-card-info">
                    <h3>${user.name}</h3>
                    <p>${user.email}</p>
                    <p style="margin-top: 5px;"><i class="fas fa-phone"></i> ${user.phone || 'بدون رقم'}</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${user.city || ''} ${user.country ? `, ${user.country}` : ''}</p>
                </div>
            `;
            
            userCard.addEventListener('click', () => {
                startChat(userId, user.name);
            });
            
            container.appendChild(userCard);
        }

        // 8. عرض صفحة المستخدمين
        document.getElementById('viewUsersBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const accountsContainer = document.getElementById('accountsContainer');
            const usersContainer = document.getElementById('usersContainer');
            
            if (usersContainer.classList.contains('hidden')) {
                accountsContainer.classList.add('hidden');
                usersContainer.classList.remove('hidden');
                document.querySelector('.page-title').textContent = 'المستخدمين النشطين';
                await loadUsers();
            } else {
                usersContainer.classList.add('hidden');
                accountsContainer.classList.remove('hidden');
                document.querySelector('.page-title').textContent = 'الحسابات المتاحة للشراء';
            }
        });

        // 9. إدارة نافذة الإضافة
        document.getElementById('openAddModal').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('addModal').style.display = 'flex';
        });

        document.getElementById('closeAddModal').addEventListener('click', () => {
            document.getElementById('addModal').style.display = 'none';
        });

        // 10. رفع الصور باستخدام IMGBB
        document.getElementById('imageUploadArea').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files).slice(0, 3);
            
            for (const file of files) {
                await uploadImageToIMGBB(file);
            }
        });

        // 11. رفع الصورة إلى IMGBB
        async function uploadImageToIMGBB(file) {
            if (uploadedImages.length >= 3) {
                showAlert('يمكنك رفع 3 صور كحد أقصى', 'info');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', imgbbApiKey);
            
            try {
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    uploadedImages.push(data.data.url);
                    updateImagePreview();
                } else {
                    showAlert('فشل في رفع الصورة', 'error');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                showAlert('حدث خطأ في رفع الصورة', 'error');
            }
        }

        // 12. تحديث معاينة الصور
        function updateImagePreview() {
            const preview = document.getElementById('imagesPreview');
            preview.innerHTML = '';
            
            uploadedImages.forEach((url, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                item.innerHTML = `
                    <img src="${url}" alt="صورة الإثبات">
                    <div class="remove-image" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                preview.appendChild(item);
            });
        }

        // 13. إزالة صورة
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }

        // 14. إضافة حساب جديد
        document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (uploadedImages.length < 2) {
                showAlert('يرجى رفع صورتين على الأقل كإثبات للملكية', 'error');
                return;
            }
            
            const platform = document.getElementById('accountPlatform').value;
            const username = document.getElementById('accountUsername').value;
            const followers = parseInt(document.getElementById('accountFollowers').value);
            const price = parseInt(document.getElementById('accountPrice').value);
            const description = document.getElementById('accountDescription').value;
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            try {
                await db.collection('accounts').add({
                    platform,
                    username,
                    followers,
                    price,
                    description,
                    proofImages: uploadedImages,
                    sellerId: currentUser.uid,
                    sellerName: userData.name,
                    sellerAvatarColor: userData.avatarColor,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                showAlert('تم نشر الحساب بنجاح!', 'success');
                
                // إعادة التعيين
                document.getElementById('addModal').style.display = 'none';
                document.getElementById('addAccountForm').reset();
                uploadedImages = [];
                updateImagePreview();
                
                // إعادة تحميل الحسابات
                loadAccounts();
            } catch (error) {
                console.error('Error adding account:', error);
                showAlert('حدث خطأ في نشر الحساب', 'error');
            }
        });

        // 15. التواصل مع البائع
        async function contactSeller(sellerId) {
            try {
                const sellerDoc = await db.collection('users').doc(sellerId).get();
                const seller = sellerDoc.data();
                
                alert(`معلومات البائع:\n\nالاسم: ${seller.name}\nالهاتف: ${seller.phone || 'غير متوفر'}\nالبريد: ${seller.email}\nالدولة: ${seller.country || 'غير محدد'}\nالمدينة: ${seller.city || 'غير محدد'}`);
            } catch (error) {
                showAlert('حدث خطأ في تحميل معلومات البائع', 'error');
            }
        }

        // 16. بدء الدردشة
        function startChat(userId, userName) {
            currentChatUser = { id: userId, name: userName };
            
            document.getElementById('chatAvatar').textContent = userName.charAt(0);
            document.getElementById('chatUserName').textContent = userName;
            document.getElementById('chatModal').style.display = 'flex';
            
            loadChatMessages();
            setupChatListener();
        }

        // 17. إغلاق الدردشة
        document.getElementById('closeChat').addEventListener('click', () => {
            document.getElementById('chatModal').style.display = 'none';
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            currentChatUser = null;
        });

        // 18. تحميل الرسائل
        async function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '<p style="text-align: center; color: #94a3b8;">جاري تحميل المحادثة...</p>';
            
            try {
                const chatId = [currentUser.uid, currentChatUser.id].sort().join('_');
                const snapshot = await db.collection('chats')
                    .doc(chatId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .limit(50)
                    .get();
                
                chatMessages.innerHTML = '';
                
                if (snapshot.empty) {
                    chatMessages.innerHTML = '<p style="text-align: center; color: #94a3b8;">ابدأ محادثة جديدة</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    addMessageToChat(message, false);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
                chatMessages.innerHTML = '<p style="text-align: center; color: #ef4444;">حدث خطأ في تحميل المحادثة</p>';
            }
        }

        // 19. إعداد مستمع الرسائل
        function setupChatListener() {
            if (chatListener) chatListener();
            
            const chatId = [currentUser.uid, currentChatUser.id].sort().join('_');
            
            chatListener = db.collection('chats')
                .doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            addMessageToChat(message, true);
                        }
                    });
                });
        }

        // 20. إضافة رسالة للدردشة
        function addMessageToChat(message, scrollToBottom) {
            const chatMessages = document.getElementById('chatMessages');
            
            // إزالة رسالة التحميل
            if (chatMessages.children.length === 1 && chatMessages.children[0].tagName === 'P') {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            messageDiv.textContent = message.text;
            
            chatMessages.appendChild(messageDiv);
            
            if (scrollToBottom) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 21. إرسال رسالة
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !currentChatUser) return;
            
            const chatId = [currentUser.uid, currentChatUser.id].sort().join('_');
            
            try {
                // إضافة الرسالة
                await db.collection('chats').doc(chatId).collection('messages').add({
                    text,
                    senderId: currentUser.uid,
                    senderName: (await db.collection('users').doc(currentUser.uid).get()).data().name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // تحديث المحادثة
                await db.collection('chats').doc(chatId).set({
                    participants: [currentUser.uid, currentChatUser.id],
                    lastMessage: text,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('حدث خطأ في إرسال الرسالة', 'error');
            }
        });

        // 22. إرسال بالضغط على Enter
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessageBtn').click();
            }
        });

        // 23. عرض التطبيق
        function showApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('app').classList.add('loaded');
            }, 100);
        }

        // 24. إظهار التنبيهات
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.getElementById('alertContainer').appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // 25. الحصول على لون عشوائي
        function getRandomColor() {
            const colors = [
                'linear-gradient(90deg, #3b82f6, #8b5cf6)',
                'linear-gradient(90deg, #10b981, #34d399)',
                'linear-gradient(90deg, #f59e0b, #f97316)',
                'linear-gradient(90deg, #8b5cf6, #ec4899)',
                'linear-gradient(90deg, #06b6d4, #0ea5e9)'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // 26. إغلاق النوافذ بالنقر خارجها
        window.addEventListener('click', (e) => {
            if (e.target.id === 'addModal') {
                document.getElementById('addModal').style.display = 'none';
            }
        });

        // 27. تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            initAuth();
            
            // إخفاء التحميل بعد 2 ثانية
            setTimeout(() => {
                const loadingElement = document.querySelector('.loading-spinner');
                if (loadingElement) loadingElement.style.display = 'none';
            }, 2000);
        });
    </script>
</body>
</html>
